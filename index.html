<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>FastEmail</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />

    <style>
      body {
        font-family: "Poppins", sans-serif;
      }
    </style>
  </head>
  <body class="">
    <nav class="navbar navbar-expand-md navbar-dark bg-primary fixed-top">
      <a class="navbar-brand" href="#">FastMail</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarsExampleDefault"
        aria-controls="navbarsExampleDefault"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link" href="https://fastmail.email">Generator</a>
          </li>
        </ul>
        <a
          class="btn btn-outline-light"
          href="https://github.com/rexlManu/fastmail"
          >Github</a
        >
      </div>
    </nav>
    <div class="container pt-5" id="app">
      <div class="mt-5">
        <div class="card">
          <div class="card-header bg-primary text-white">Generate mail</div>
          <div class="card-body">
            <div class="form-group">
              <label
                >Username
                <span class="text-muted"
                  >(Has no use except as Fake It replacement)</span
                ></label
              >
              <input class="form-control" v-model="username" />
            </div>

            <label
              >E-Mail
              <a v-if="username" href="javascript:void(1)" v-on:click="copyMail"
                >({{ fullMail() }})</a
              ></label
            >

            <div class="input-group mb-3">
              <input type="text" v-model="username" class="form-control" />
              <select class="custom-select" v-model="mail">
                <option
                  v-for="mail in mails"
                  v-bind:value="mail"
                  :selected="mail == this.mail"
                >
                  {{ mail }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label
                >Password
                <span class="text-muted"
                  >(Has no use except as Fake It replacement)</span
                ></label
              >
              <input class="form-control" v-model="password" />
            </div>
            <button v-on:click="generate" class="btn btn-primary">
              Generate
            </button>
            <button v-on:click="reset" class="btn btn-danger">Reset</button>
            <button v-on:click="generate(true)" class="btn btn-outline-success">
              Generate and save
            </button>
            <button v-on:click="save" class="btn btn-success">Save</button>
            <button v-on:click="fetchMessages" class="btn btn-warning">
              Fetch messages
            </button>

            <span class="badge badge-primary"
              >{{ messages.length }} fetched messages</span
            >

            <div class="mt-3" v-if="messages.length">
              <div class="accordion" id="accordionExample">
                <div class="card" v-for="message in messages">
                  <div class="card-header" id="headingOne">
                    <h2 class="mb-0">
                      <button
                        class="btn btn-link btn-block text-left"
                        type="button"
                        v-on:click="toggle(message)"
                      >
                        {{ message.date }} - {{ message.subject}}
                        <span class="float-right"
                          >{{ message.sender.name }} <{{ message.sender.address
                          }}></span
                        >
                      </button>
                    </h2>
                  </div>

                  <div
                    id="collapseOne"
                    class="collapse"
                    v-bind:class="{ show: message.show }"
                  >
                    <div class="card-body" v-html="message.body"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="container fixed-bottom">
      <p>Â© FastMail 2020 <a class="float-right" href="/imprint">Imprint</a></p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script>
      var app = new Vue({
        el: "#app",
        data: {
          mails: ["fastmail.email"],
          username: null,
          mail: null,
          password: null,
          messages: [],
        },
        created() {
          if (location.hash) {
            var data = JSON.parse(atob(location.hash.substring(1)));
            this.username = data.username;
            this.mail = data.mail;
            this.password = data.password;
          } else {
            this.mail = this.mails[0];
          }
        },
        methods: {
          generate(save = false) {
            this.username = Math.random().toString(36).substr(2, 5);
            this.password = Math.random().toString(36).substring(2);
            if (save) {
              this.save();
            }
          },
          save() {
            location.hash = btoa(
              JSON.stringify({
                username: this.username,
                mail: this.mail,
                password: this.password,
              })
            );
          },
          fullMail() {
            return this.username + "@" + this.mail;
          },
          reset() {
            this.username = "";
            this.password = "";
            location.hash = "";
            this.messages = [];
          },
          fetchMessages() {
            fetch("/api/mails", {
              method: "post",
              body: JSON.stringify({ username: this.username }),
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => response.json())
              .then((json) => {
                json.forEach((message) => (message.show = false));
                this.messages = json;
              })
              .catch((e) => {
                alert(e.error || "Messages could not be fetched.");
                this.messages = [];
              });
          },
          toggle(message) {
            message.show = !message.show;
          },
          copyMail() {
            navigator.clipboard.writeText(this.fullMail());
          },
        },
      });
    </script>
  </body>
</html>
